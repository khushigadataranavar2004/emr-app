name: Deploy Laravel EMR to AWS

on:
  push:
    branches: [ main ] # This triggers whenever you "git push"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            # 1. Force a clean update and install Nginx
            # Using --fix-missing ensures we don't fail if a mirror is temporarily down
            sudo apt-get update --fix-missing -y
            sudo apt-get install -y nginx --install-recommends
            
            # 2. CRITICAL: Verify installation - if this fails, the script STOPS
            # This prevents the "False Green" checkmark you saw earlier
            if ! command -v nginx > /dev/null; then
              echo "NGINX INSTALLATION FAILED! Check apt logs."
              exit 1
            fi

            # 3. Install PHP and MongoDB driver
            sudo apt-get install -y php8.2-fpm php8.2-curl php8.2-mongodb php8.2-mbstring php8.2-xml php8.2-bcmath
            
            # 4. Deployment logic
            cd /var/www/html/emr-app
            git pull origin main
            composer install --no-dev --optimize-autoloader
            npm install
            npm run build
            
            # 5. Laravel Optimization
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache

            # 6. Final Service Restart
            # Ensures the webserver is ON and PHP knows about the new MongoDB driver
            sudo systemctl start nginx
            sudo systemctl restart php8.2-fpm || sudo systemctl restart php*-fpm